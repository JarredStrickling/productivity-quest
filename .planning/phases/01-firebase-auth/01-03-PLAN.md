---
phase: 01-firebase-auth
plan: 03
type: execute
wave: 3
depends_on:
  - "01-01"
  - "01-02"
files_modified:
  - src/App.jsx
  - src/App.css
autonomous: false
requirements:
  - ACCT-01
  - ACCT-02
  - ACCT-03

must_haves:
  truths:
    - "A new user can register with a unique username and password and reach the main menu"
    - "A returning user who closes and reopens the browser is automatically logged back in without re-entering credentials"
    - "A logged-in user can tap Log Out from any screen and be returned to the splash screen then auth modal"
    - "Firebase Auth error messages are human-readable (not raw error codes)"
    - "The Phaser game instance only initializes after the auth state resolves and user is authenticated (no race condition)"
    - "A confirm dialog appears before logout completes"
  artifacts:
    - path: "src/App.jsx"
      provides: "Auth-gated app with splash -> auth -> game flow"
      contains: "useAuth"
    - path: "src/App.css"
      provides: "Updated styles for auth-aware layout"
  key_links:
    - from: "src/App.jsx"
      to: "src/hooks/useAuth.js"
      via: "useAuth() for currentUser, authResolved, logout"
      pattern: "useAuth\\(\\)"
    - from: "src/App.jsx"
      to: "src/components/SplashScreen.jsx"
      via: "renders SplashScreen when !authResolved"
      pattern: "<SplashScreen"
    - from: "src/App.jsx"
      to: "src/components/AuthModal.jsx"
      via: "renders AuthModal when authResolved && !currentUser"
      pattern: "<AuthModal"
    - from: "src/App.jsx"
      to: "new Phaser.Game"
      via: "Phaser init gated behind authResolved && currentUser"
      pattern: "new Phaser\\.Game"
---

<objective>
Wire the auth gate into App.jsx to create the complete auth flow: SplashScreen (while resolving) -> AuthModal (if not logged in) -> Game (if authenticated). Fix the Phaser initialization race condition by only creating the game instance after auth resolves. Add logout capability from any screen with confirm dialog.

Purpose: This is the integration plan that connects the Firebase foundation (Plan 01) and UI components (Plan 02) into the existing app. Without this, the auth system exists but is not wired into the user experience. The Phaser race condition (documented in STATE.md) is also resolved here.

Output: Updated `src/App.jsx` with auth gate flow, updated `src/App.css` with any necessary auth-aware styles.
</objective>

<execution_context>
@C:/Users/jarre/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/jarre/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-firebase-auth/01-CONTEXT.md
@.planning/phases/01-firebase-auth/01-RESEARCH.md
@.planning/phases/01-firebase-auth/01-01-SUMMARY.md
@.planning/phases/01-firebase-auth/01-02-SUMMARY.md
@src/App.jsx
@src/App.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Restructure App.jsx with auth gate and Phaser init fix</name>
  <files>src/App.jsx, src/App.css</files>
  <action>
This task restructures App.jsx to gate the entire app behind Firebase auth state. The core change is: Phaser ONLY initializes after `authResolved === true` AND `currentUser !== null`.

**App.jsx changes:**

1. **New imports:**
   - `import { useAuth } from './hooks/useAuth'`
   - `import SplashScreen from './components/SplashScreen'`
   - `import AuthModal from './components/AuthModal'`
   - Remove: `import TitleScreen from './components/TitleScreen'` (replaced by SplashScreen)

2. **Get auth state at top of App component:**
   ```javascript
   const { currentUser, authResolved, userProfile, logout } = useAuth()
   ```

3. **New state variables:**
   - `const [authError, setAuthError] = useState(null)` — for auto-login failure display on splash
   - `const [showTransition, setShowTransition] = useState(false)` — brief transition after auth success
   - Remove `showTitleScreen` state (replaced by splash/auth flow)

4. **Auth gate flow (conditional rendering at top of return):**

   The render logic should follow this priority order:

   **Stage 1: Splash Screen (auth resolving OR transition)**
   - If `!authResolved`: render `<SplashScreen />` — Firebase hasn't determined auth state yet
   - If `showTransition`: render `<SplashScreen />` — brief transition animation after login/register success (1-2 seconds per CONTEXT.md)

   **Stage 2: Auth Modal (no user)**
   - If `authResolved && !currentUser && !showTransition`: render `<AuthModal isOpen={true} onAuthSuccess={handleAuthSuccess} />`

   **Stage 3: Game (authenticated)**
   - If `authResolved && currentUser`: render the full game UI (existing JSX — everything from game-canvas onward)

5. **`handleAuthSuccess` callback:**
   - Set `showTransition` to true
   - After a brief delay (~1.5 seconds per CONTEXT.md: "fixed minimum splash duration"), set `showTransition` to false
   - The splash screen during transition gives a smooth visual handoff from auth -> game

6. **Phaser initialization change (CRITICAL — fixes race condition from STATE.md):**
   - The existing `useEffect` that creates `new Phaser.Game(config)` currently runs on mount (`[]` deps)
   - Change: Add `currentUser` to the dependency check. The Phaser game should ONLY be created when `currentUser` is truthy.
   - Guard the Phaser init: `if (!gameRef.current || !currentUser || gameInstanceRef.current) return`
   - This ensures Phaser does not init until: (a) the game container div is mounted, (b) the user is authenticated, (c) no game already exists
   - The game container `<div ref={gameRef}>` is only rendered in Stage 3 (authenticated), so `gameRef.current` will be null during splash/auth stages. The useEffect should depend on `currentUser` and re-run when it changes from null to a user object.
   - Cleanup: On `currentUser` becoming null (logout), destroy the Phaser instance: `gameInstanceRef.current.destroy(true); gameInstanceRef.current = null`

7. **Logout flow:**
   - Replace the existing "home button" (emoji house button in top-right, lines 354-387) with a proper logout flow:
   - The home button currently resets playerStats and shows MainMenu. Instead, it should:
     - Show a confirm dialog: `window.confirm('Are you sure you want to log out?')` (per CONTEXT.md)
     - If confirmed: call `logout()` from useAuth, reset all game state (playerStats, modal visibility, etc.)
     - After logout: `onAuthStateChanged` fires with null user, `currentUser` becomes null, app renders splash then auth modal (per CONTEXT.md: "After logout: splash screen first, then auth modal appears")
   - Keep the button in the same top-right position but change the label/aria to "Log Out"
   - Also add "Log Out" option accessible from within the game (the home button IS the logout for Phase 1 — the settings menu mentioned in CONTEXT.md for showing username is not yet built)

8. **Returning user flow (auto-login):**
   - Per CONTEXT.md: "Returning users who are auto-logged-in still see the brief splash screen"
   - This is already handled: on page load, `authResolved` starts false (splash shows), then `onAuthStateChanged` fires with user (if persisted). When auth resolves with a user:
     - Add a brief splash hold: set a `minSplashShown` flag using a timer (1-2 seconds) that must complete before transitioning to game. If auth resolves before the timer, wait for the timer. If auth takes longer, transition immediately when it resolves.
   - Implementation: use a `splashMinTimeElapsed` state, set to true after 1.5s timeout on mount. Only transition from splash when BOTH `authResolved` AND `splashMinTimeElapsed` are true.

9. **Auth failure on auto-login:**
   - Per CONTEXT.md: "Auth failure on auto-login: stay on splash with retry button and error message"
   - If `onAuthStateChanged` fires with an error (rare but possible), set `authError` state
   - Pass `showError={!!authError}`, `errorMessage={authError}`, `onRetry={() => window.location.reload()}` to SplashScreen

10. **Remove TitleScreen references:**
    - Remove `showTitleScreen` state
    - Remove TitleScreen import
    - Remove TitleScreen conditional rendering block
    - The SplashScreen replaces TitleScreen's role entirely

11. **MainMenu adjustments:**
    - MainMenu should still show after splash/auth when user first logs in (it handles save slot selection and new game)
    - The `showMainMenu` state should still start as `true` so authenticated users see it first
    - Returning users with auto-login still see MainMenu after splash (they pick save slot / continue)

12. **App.css updates:**
    - Remove any TitleScreen-related styles if they exist in App.css
    - Add `.logout-button` style: positioned top-right, RPG-themed small button (matching existing home-button position but with text "Log Out" instead of emoji), z-index above game canvas
    - Ensure `.game-canvas` has proper z-index layering so splash/auth overlay it correctly
  </action>
  <verify>
- `npm run build` succeeds
- App.jsx imports useAuth, SplashScreen, AuthModal (and no longer imports TitleScreen)
- Phaser.Game creation is gated behind `currentUser` being truthy
- The auth gate renders: SplashScreen (resolving) -> AuthModal (no user) -> Game (authenticated)
- Logout button calls `logout()` from useAuth with confirm dialog
- No `showTitleScreen` state remains
  </verify>
  <done>App.jsx gates all game rendering behind Firebase auth state. Phaser only initializes after auth resolves with an authenticated user (race condition fixed). Splash screen shows during auth resolution with minimum 1.5s display. Auth modal appears for unauthenticated users. Logout from any screen triggers confirm dialog, clears state, destroys Phaser, and returns to splash then auth modal. Returning users see brief splash before auto-resuming.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify complete auth flow end-to-end</name>
  <files>src/App.jsx</files>
  <action>
Human verification checkpoint. What was built: Complete Firebase Auth integration — splash screen, registration, login, session persistence, logout, Phaser initialization gating.

Prerequisites: Ensure `.env` file has valid Firebase config values and Firebase project has Email/Password auth enabled and Firestore database created.

Verification steps:

1. **Fresh load (no session):**
   - Run `npm run dev` and open the app in browser
   - Verify: Splash screen appears with Scrolls of Doom logo and subtle glow animation on black background
   - Verify: After ~1.5 seconds, auth modal appears with RPG parchment theme
   - Verify: Login view is shown by default with username and password fields

2. **Registration:**
   - Click "Sign Up" toggle link
   - Verify: Form switches to show username, email, password, confirm password fields
   - Try submitting with empty fields -> inline errors appear below each field
   - Try a username shorter than 3 chars -> error below username field
   - Try mismatched passwords -> error below confirm password field
   - Fill in valid data (new username, real email, password 6+ chars)
   - Click "Sign Up" -> button disables with spinner
   - Verify: "Account created!" message appears briefly, then game loads
   - Verify: Phaser game world renders (player sprite visible, can drag to move)
   - Verify: MainMenu appears for save slot selection

3. **Session persistence:**
   - Close the browser tab completely
   - Reopen the app URL
   - Verify: Splash screen shows briefly (~1.5s)
   - Verify: App auto-logs in (no auth modal) and goes straight to MainMenu/game
   - Verify: No Phaser initialization errors in console

4. **Logout:**
   - Click the Log Out button (top-right area)
   - Verify: Confirm dialog appears ("Are you sure you want to log out?")
   - Click "OK"
   - Verify: Splash screen appears, then auth modal shows
   - Verify: Phaser game is destroyed (no game canvas visible behind auth modal)

5. **Login:**
   - Enter the username and password from step 2
   - Click "Log In"
   - Verify: Game loads after brief splash transition

6. **Forgot password:**
   - Log out, then click "Forgot password?" link on login form
   - Verify: Email input field appears
   - Enter the email used during registration
   - Click "Send Reset Link"
   - Verify: "Check your email" confirmation message appears

7. **Error handling:**
   - Try logging in with wrong password -> "Incorrect username or password." error
   - Try registering with a taken username -> "Username already taken." error
   - Verify: Error messages are human-readable, not raw Firebase codes

8. **Mobile check:**
   - Open browser DevTools, toggle device toolbar (mobile view)
   - Verify: Auth modal is full-screen on mobile-sized viewport
   - Verify: All fields are usable and form is scrollable if content overflows
  </action>
  <verify>All 8 verification steps pass without issues. No console errors related to auth or Phaser initialization.</verify>
  <done>Complete auth flow verified by human: splash, registration, login, persistence, logout, forgot password, error handling, and mobile layout all working correctly.</done>
</task>

</tasks>

<verification>
- Complete auth flow works: splash -> register/login -> game -> logout -> splash -> auth modal
- Phaser never initializes before auth resolves (no console errors about undefined player state)
- Session persists across browser restart (auto-login works)
- Logout clears session and game state, shows confirm dialog
- Error messages are human-readable
- Mobile layout is full-screen for auth modal
- RPG parchment theme matches existing modals
</verification>

<success_criteria>
A new user can register, see "Account created!", and enter the game. A returning user is auto-logged in after a brief splash. Logout from any screen returns to auth flow with confirm dialog. Firebase error codes are never shown to users. Phaser only starts after auth resolves. The entire flow works on mobile with full-screen auth modal.
</success_criteria>

<output>
After completion, create `.planning/phases/01-firebase-auth/01-03-SUMMARY.md`
</output>
