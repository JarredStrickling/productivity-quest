---
phase: 01-firebase-auth
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/firebase.js
  - src/hooks/useAuth.js
  - src/main.jsx
  - .env.example
  - .gitignore
autonomous: true
requirements:
  - ACCT-01
  - ACCT-02
  - ACCT-03
user_setup:
  - service: firebase
    why: "Firebase Auth + Firestore for user accounts and username storage"
    env_vars:
      - name: VITE_FIREBASE_API_KEY
        source: "Firebase Console -> Project Settings -> General -> Your apps -> Web app -> Config"
      - name: VITE_FIREBASE_AUTH_DOMAIN
        source: "Firebase Console -> Project Settings -> General -> Your apps -> Web app -> Config"
      - name: VITE_FIREBASE_PROJECT_ID
        source: "Firebase Console -> Project Settings -> General -> Your apps -> Web app -> Config"
      - name: VITE_FIREBASE_STORAGE_BUCKET
        source: "Firebase Console -> Project Settings -> General -> Your apps -> Web app -> Config"
      - name: VITE_FIREBASE_MESSAGING_SENDER_ID
        source: "Firebase Console -> Project Settings -> General -> Your apps -> Web app -> Config"
      - name: VITE_FIREBASE_APP_ID
        source: "Firebase Console -> Project Settings -> General -> Your apps -> Web app -> Config"
    dashboard_config:
      - task: "Create Firebase project (or use existing)"
        location: "Firebase Console -> Add Project"
      - task: "Enable Email/Password sign-in method"
        location: "Firebase Console -> Authentication -> Sign-in method -> Email/Password -> Enable"
      - task: "Create Firestore database in production mode"
        location: "Firebase Console -> Firestore Database -> Create database"
      - task: "Register a Web app to get config values"
        location: "Firebase Console -> Project Settings -> General -> Add app -> Web"

must_haves:
  truths:
    - "Firebase app initializes once without errors on page load"
    - "onAuthStateChanged fires its first value (null for logged-out user) and authResolved becomes true"
    - "AuthProvider wraps the entire React app and useAuth() returns context values from any child component"
  artifacts:
    - path: "src/firebase.js"
      provides: "Firebase singleton with auth and db exports"
      exports: ["auth", "db"]
    - path: "src/hooks/useAuth.js"
      provides: "AuthContext, AuthProvider, and useAuth hook"
      exports: ["AuthProvider", "useAuth"]
    - path: "src/main.jsx"
      provides: "App wrapped in AuthProvider"
      contains: "AuthProvider"
  key_links:
    - from: "src/hooks/useAuth.js"
      to: "src/firebase.js"
      via: "imports auth singleton"
      pattern: "import.*auth.*from.*firebase"
    - from: "src/main.jsx"
      to: "src/hooks/useAuth.js"
      via: "wraps App with AuthProvider"
      pattern: "<AuthProvider>"
---

<objective>
Install Firebase SDK, create the Firebase singleton with explicit Vite-safe persistence, implement the useAuth hook with AuthContext providing auth state and operations, and wrap the app in AuthProvider.

Purpose: Establishes the auth infrastructure that all other Phase 1 plans depend on. Without this foundation, there is no auth state to gate the UI on and no Firebase connection to register/login users.

Output: `src/firebase.js` singleton, `src/hooks/useAuth.js` hook, updated `src/main.jsx` with AuthProvider wrapper, updated `.env.example` with Firebase config keys.
</objective>

<execution_context>
@C:/Users/jarre/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/jarre/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-firebase-auth/01-CONTEXT.md
@.planning/phases/01-firebase-auth/01-RESEARCH.md
@src/main.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Firebase SDK and create Firebase singleton</name>
  <files>src/firebase.js, .env.example, .gitignore</files>
  <action>
1. Run `npm install firebase` to install Firebase SDK (target ^12.x, latest).

2. Create `src/firebase.js` as the Firebase singleton:
   - Import `initializeApp` from `firebase/app`
   - Import `initializeAuth`, `browserLocalPersistence` from `firebase/auth`
   - Import `getFirestore` from `firebase/firestore`
   - Read config from `import.meta.env.VITE_FIREBASE_*` environment variables (6 keys: apiKey, authDomain, projectId, storageBucket, messagingSenderId, appId)
   - Call `initializeApp(firebaseConfig)` once
   - MUST use `initializeAuth(app, { persistence: browserLocalPersistence })` instead of `getAuth()` to avoid the Vite persistence bug (GitHub firebase-js-sdk Issue #8626 — onAuthStateChanged silently fails to restore sessions with getAuth in Vite)
   - Call `getFirestore(app)` for Firestore access (needed for username storage)
   - Export `auth` and `db` as named exports

3. Update `.env.example` to include the 6 Firebase config keys with VITE_ prefix (keep existing ANTHROPIC_API_KEY and PORT entries):
   ```
   # Firebase Configuration
   # Get these from: Firebase Console -> Project Settings -> General -> Your apps -> Web app
   VITE_FIREBASE_API_KEY=your-api-key
   VITE_FIREBASE_AUTH_DOMAIN=your-project.firebaseapp.com
   VITE_FIREBASE_PROJECT_ID=your-project-id
   VITE_FIREBASE_STORAGE_BUCKET=your-project.firebasestorage.app
   VITE_FIREBASE_MESSAGING_SENDER_ID=your-messaging-sender-id
   VITE_FIREBASE_APP_ID=your-app-id
   ```

4. Verify `.gitignore` already excludes `.env` (it does — just confirm, do not modify if already present).
  </action>
  <verify>
- `npm ls firebase` shows firebase installed at ^12.x
- `src/firebase.js` exists with `initializeAuth` (not `getAuth`) and exports `auth` and `db`
- `.env.example` contains all 6 `VITE_FIREBASE_*` keys
- `npm run build` completes without import errors (Firebase tree-shakes unused modules)
  </verify>
  <done>Firebase SDK installed, singleton created with Vite-safe persistence, env template updated with all required config keys.</done>
</task>

<task type="auto">
  <name>Task 2: Create useAuth hook with AuthProvider and wire into main.jsx</name>
  <files>src/hooks/useAuth.js, src/main.jsx</files>
  <action>
1. Create directory `src/hooks/` if it does not exist.

2. Create `src/hooks/useAuth.js`:
   - Import `createContext`, `useContext`, `useEffect`, `useState` from React
   - Import `onAuthStateChanged`, `signInWithEmailAndPassword`, `createUserWithEmailAndPassword`, `signOut`, `sendPasswordResetEmail` from `firebase/auth`
   - Import `doc`, `getDoc`, `writeBatch` from `firebase/firestore`
   - Import `auth`, `db` from `../firebase`

   - Create `AuthContext` with `createContext(null)`

   - Create `AUTH_ERROR_MESSAGES` map for human-readable errors (per CONTEXT.md: straightforward tone):
     - `'auth/invalid-credential'`: `'Incorrect username or password.'`
     - `'auth/invalid-login-credentials'`: `'Incorrect username or password.'`
     - `'auth/user-disabled'`: `'This account has been disabled.'`
     - `'auth/too-many-requests'`: `'Too many attempts. Try again later.'`
     - `'auth/network-request-failed'`: `'No internet connection — check your connection and try again.'` (per CONTEXT.md: specific offline message)
     - `'auth/email-already-in-use'`: `'An account with this email already exists.'`
     - `'auth/weak-password'`: `'Password must be at least 6 characters.'`
     - `'auth/invalid-email'`: `'Please enter a valid email address.'`
     - `'USERNAME_TAKEN'`: `'Username already taken.'`
     - `'INVALID_CREDENTIALS'`: `'Incorrect username or password.'`
     - `'REGISTRATION_FAILED'`: `'Registration failed. Please try again.'`

   - Export `getAuthErrorMessage(error)` function:
     ```
     return AUTH_ERROR_MESSAGES[error.code || error.message] || 'Something went wrong. Please try again.'
     ```

   - Create and export `AuthProvider` component:
     - State: `currentUser` (null), `authResolved` (false), `userProfile` (null — stores Firestore user doc with username)
     - `useEffect`: Subscribe to `onAuthStateChanged(auth, callback)`. On fire:
       - Set `currentUser` to user (or null)
       - Set `authResolved` to true (always, whether user is null or not)
       - If user is not null, fetch Firestore user profile: `getDoc(doc(db, 'users', user.uid))` and set `userProfile` to the doc data. If doc doesn't exist (edge case), set userProfile to null.
       - If user is null, set `userProfile` to null
     - Return cleanup: `unsubscribe()` (critical: prevents memory leak)

   - Implement `register(username, email, password)` async function:
     - Lowercase username: `const usernameLower = username.toLowerCase()`
     - Validate username format: 3-20 chars, letters/numbers/underscores only (`/^[a-zA-Z0-9_]{3,20}$/`)
     - Check availability: `getDoc(doc(db, 'usernames', usernameLower))` — if exists, throw `{ code: 'USERNAME_TAKEN' }`
     - Create Firebase Auth account: `createUserWithEmailAndPassword(auth, email, password)`
     - Atomic Firestore batch write:
       - `usernames/{usernameLower}` doc: `{ uid: cred.user.uid }`
       - `users/{uid}` doc: `{ username, usernameLower, email, createdAt: new Date() }`
     - If batch fails, clean up orphaned auth account: `await cred.user.delete()` then throw `{ code: 'REGISTRATION_FAILED' }` (per RESEARCH.md Pitfall 4)
     - On success, manually set `userProfile` state to `{ username, usernameLower, email, createdAt: new Date() }` (avoids race condition where onAuthStateChanged fires before Firestore write completes — per RESEARCH.md Pitfall 5)
     - Return `cred`

   - Implement `login(username, password)` async function:
     - Lowercase username: `const usernameLower = username.toLowerCase()`
     - Look up username doc: `getDoc(doc(db, 'usernames', usernameLower))`
     - If not exists, throw `{ code: 'INVALID_CREDENTIALS' }` (do not reveal whether username exists — consistent with email enumeration protection)
     - Get uid from username doc, then get user doc to retrieve email
     - Call `signInWithEmailAndPassword(auth, email, password)`
     - Return credential

   - Implement `logout()` async function:
     - Call `signOut(auth)`
     - Clear localStorage save slots: `saveSlot1`, `saveSlot2`, `saveSlot3` (per RESEARCH.md: clear on logout to prevent data leakage on shared devices)
     - Set `userProfile` to null

   - Implement `resetPassword(email)` async function:
     - Call `sendPasswordResetEmail(auth, email)`
     - No confirmation of email existence returned (email enumeration protection)

   - Context value: `{ currentUser, authResolved, userProfile, register, login, logout, resetPassword, getAuthErrorMessage }`

   - Export `useAuth` as `() => useContext(AuthContext)`

3. Update `src/main.jsx`:
   - Import `AuthProvider` from `./hooks/useAuth`
   - Wrap `<App />` with `<AuthProvider>` inside `<StrictMode>`
   - Result: `<StrictMode><AuthProvider><App /></AuthProvider></StrictMode>`
  </action>
  <verify>
- `src/hooks/useAuth.js` exists and exports `AuthProvider`, `useAuth`, `getAuthErrorMessage`
- `src/main.jsx` wraps App in AuthProvider
- `npm run build` completes without errors
- In browser console with React DevTools: AuthContext.Provider is visible in component tree
  </verify>
  <done>useAuth hook provides currentUser, authResolved, userProfile, register (with username uniqueness + batch write + orphan cleanup), login (username lookup then email sign-in), logout (with localStorage cleanup), resetPassword, and getAuthErrorMessage. App is wrapped in AuthProvider.</done>
</task>

</tasks>

<verification>
- `npm run build` succeeds (no import/export errors)
- `src/firebase.js` uses `initializeAuth` with `browserLocalPersistence` (not `getAuth`)
- `src/hooks/useAuth.js` exports AuthProvider, useAuth, getAuthErrorMessage
- `src/main.jsx` has `<AuthProvider>` wrapping `<App />`
- `.env.example` documents all 6 Firebase config keys
- No secrets committed (`.env` is in `.gitignore`)
</verification>

<success_criteria>
Firebase SDK installed and singleton created. useAuth hook implemented with full registration (username uniqueness via Firestore, orphan cleanup), login (username-to-email resolution), logout (with localStorage cleanup), and password reset. AuthProvider wraps the entire app. Build succeeds.
</success_criteria>

<output>
After completion, create `.planning/phases/01-firebase-auth/01-01-SUMMARY.md`
</output>
