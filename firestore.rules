rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Username lookup — readable by anyone (login resolution); writable by authenticated users (registration)
    match /usernames/{usernameLower} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    // User profiles — public read (login needs username-to-email resolution before auth), owner-only write
    match /users/{userId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == userId;

      // Character save slots — owner only, constrained fields on create/update
      match /characters/{slotId} {
        allow read: if request.auth != null && request.auth.uid == userId;

        // New character must start at level 1, XP 0
        allow create: if request.auth != null
          && request.auth.uid == userId
          && request.resource.data.level == 1
          && request.resource.data.xp == 0;

        // Updates: level can only go up (max +1 per write, cap 100).
        // XP rules depend on whether a level-up occurred:
        //   Same level  → XP must increase (max +200)
        //   Level up    → XP resets to remainder (0..200 allowed)
        //   Stat alloc  → same level, same XP (passes same-level branch)
        allow update: if request.auth != null
          && request.auth.uid == userId
          && request.resource.data.level >= resource.data.level
          && request.resource.data.level <= 100
          && (request.resource.data.level - resource.data.level) <= 1
          && (
            // Same level: XP can only increase, max +200
            (request.resource.data.level == resource.data.level
              && request.resource.data.xp >= resource.data.xp
              && (request.resource.data.xp - resource.data.xp) <= 200)
            ||
            // Level up: XP resets to remainder after leveling
            (request.resource.data.level > resource.data.level
              && request.resource.data.xp >= 0
              && request.resource.data.xp <= 200)
          );

        allow delete: if request.auth != null && request.auth.uid == userId;
      }
    }

    // Session locks — owner only, no field constraints (just auth ownership)
    match /sessions/{userId} {
      allow read, write, delete: if request.auth != null && request.auth.uid == userId;
    }
  }
}
