rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Username lookup — readable by anyone (login resolution); writable by authenticated users (registration)
    match /usernames/{usernameLower} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    // User profiles — public read (login needs username-to-email resolution before auth), owner-only write
    match /users/{userId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == userId;

      // Character save slots — owner only, constrained fields on create/update
      match /characters/{slotId} {
        allow read: if request.auth != null && request.auth.uid == userId;

        // New character must start at level 1, XP 0
        allow create: if request.auth != null
          && request.auth.uid == userId
          && request.resource.data.level == 1
          && request.resource.data.xp == 0;

        // Updates: XP can only increase (max +200 per write — Legendary=150, buffer for edge cases),
        // level can only go up by 1 per write, max level 100
        allow update: if request.auth != null
          && request.auth.uid == userId
          && request.resource.data.xp >= resource.data.xp
          && (request.resource.data.xp - resource.data.xp) <= 200
          && request.resource.data.level >= resource.data.level
          && request.resource.data.level <= 100
          && (request.resource.data.level - resource.data.level) <= 1;

        allow delete: if request.auth != null && request.auth.uid == userId;
      }
    }

    // Session locks — owner only, no field constraints (just auth ownership)
    match /sessions/{userId} {
      allow read, write, delete: if request.auth != null && request.auth.uid == userId;
    }
  }
}
